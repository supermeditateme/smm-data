{"version":3,"file":"index.js","sources":["../../../../../js/lib/components/SelectedAnnotation/index.js"],"sourcesContent":["import React, { Component, PureComponent } from 'react';\nimport { connect } from 'react-redux';\n\nimport { STORE_KEY } from '../../constants';\nimport {\n  softSetCurrentTime,\n  selectAnnotation,\n  modifyAnnotation,\n  deleteAnnotation,\n} from '../../actions';\nimport {\n  getSortedAnnotations,\n  getSelectedAnnotation,\n  getSecondWidth,\n} from '../../selectors';\n\nfunction roundSec(duration) {\n  return Math.round(duration * 1000000) / 1000000;\n}\nfunction roundMs(duration) {\n  return Math.round(duration * 1000) / 1000;\n}\n\n// This component is about presentation (html structure/style) and mouse resize.\nclass SelectedAnnotation extends PureComponent {\n  constructor(props) {\n    super(props);\n\n    this.selectedRef = React.createRef();\n\n    const { time, duration, name, secondWidth } = props;\n\n    this.state = {\n      startX: time * secondWidth,\n      width: duration * secondWidth,\n      name,\n      dragging: null,\n    };\n  }\n\n  componentDidUpdate(prevProps) {\n    if (prevProps === this.props) {\n      return;\n    }\n\n    const { time, duration, name, secondWidth } = this.props;\n\n    this.setState({\n      startX: time * secondWidth,\n      width: duration * secondWidth,\n      name,\n      dragging: null,\n    });\n  }\n\n  startDraggingWest = e => {\n    this.startDragging(e, 'w');\n  };\n\n  startDraggingEast = e => {\n    this.startDragging(e, 'e');\n  };\n\n  startDragging(e, direction) {\n    this.setState(\n      {\n        dragging: {\n          direction,\n          savedPageX: e.pageX,\n          savedStartX: this.state.startX,\n          savedWidth: this.state.width,\n        },\n      },\n      () => {\n        // Not document.body , because body can fill less than 100% height.\n        document.documentElement.classList.add(\n          'cursor' + direction.toUpperCase()\n        );\n        document.documentElement.addEventListener(\n          'mousemove',\n          this.drag,\n          false\n        );\n        document.documentElement.addEventListener(\n          'mouseup',\n          this.stopDragging,\n          false\n        );\n      }\n    );\n  }\n\n  drag = e => {\n    const {\n      dragging: { direction, savedPageX, savedStartX, savedWidth },\n    } = this.state;\n\n    const delta = e.pageX - savedPageX;\n\n    let deltaRestricted;\n    switch (direction) {\n      case 'e':\n        deltaRestricted = Math.max(delta, -savedWidth);\n        this.setState({ width: savedWidth + deltaRestricted });\n        break;\n\n      case 'w':\n        deltaRestricted = Math.min(delta, savedWidth);\n        this.setState({\n          startX: savedStartX + deltaRestricted,\n          width: savedWidth - deltaRestricted,\n        });\n        break;\n\n      default:\n        break;\n    }\n  };\n\n  stopDragging = e => {\n    document.documentElement.classList.remove('cursorW');\n    document.documentElement.classList.remove('cursorE');\n    document.documentElement.removeEventListener('mousemove', this.drag, false);\n    document.documentElement.removeEventListener(\n      'mouseup',\n      this.stopDragging,\n      false\n    );\n    const { startX, width } = this.state;\n    const { secondWidth, onChange } = this.props;\n\n    this.setState({ dragging: null }, function() {\n      onChange({\n        time: startX / secondWidth,\n        duration: roundSec(width / secondWidth),\n      });\n    });\n  };\n\n  componentDidMount() {\n    // It's not elegant to put focusing behaviour here, but I cannot come up\n    // with a better solution now.\n    this.selectedRef.current.focus();\n  }\n\n  componentWillUnmount() {\n    document.documentElement.classList.remove('cursorW');\n    document.documentElement.classList.remove('cursorE');\n    document.documentElement.removeEventListener('mousemove', this.drag, false);\n    document.documentElement.removeEventListener(\n      'mouseup',\n      this.stopDragging,\n      false\n    );\n  }\n\n  render() {\n    const { secondWidth, onKeyDown, onBlur } = this.props;\n    const { startX, width, name } = this.state;\n\n    const containerWidth = Math.max(width, 2); // One border width.\n\n    const duration = width / secondWidth;\n    const durationLabel =\n      duration < 1 ? roundMs(duration * 1000) + 'ms' : roundSec(duration) + 's';\n\n    return (\n      <div\n        tabIndex=\"0\"\n        ref={this.selectedRef}\n        onKeyDown={onKeyDown}\n        className=\"selectedAnnotation\"\n        style={{\n          transform: `translateX(${startX}px)`,\n          width: containerWidth,\n        }}\n      >\n        <div className=\"leftBorder\" onMouseDown={this.startDraggingWest} />\n        <div className=\"rightBorder\" onMouseDown={this.startDraggingEast} />\n        <div className=\"annotationDuration\">\n          <div className=\"measureLine\" />\n          <div className=\"leftGapper\" />\n          <div className=\"durationLabel\">{durationLabel}</div>\n        </div>\n        <div className=\"annotationLabel\">{name}</div>\n      </div>\n    );\n  }\n}\n\n// This wrapper is about keyboard control.\nclass SelectedAnnotationWrapper extends Component {\n  handleKeyDown = e => {\n    const { sortedAnnotations, selected, dispatch } = this.props;\n    const { key } = e;\n    let idx;\n\n    switch (key) {\n      case 'Backspace':\n      case 'Delete':\n        dispatch(deleteAnnotation(selected.id));\n      // No `break` here - this way we jump to next annotation on deleting.\n\n      case 'ArrowDown':\n        idx =\n          sortedAnnotations.findIndex(\n            annotation => annotation.id === selected.id\n          ) + 1;\n        idx = idx < sortedAnnotations.length ? idx : 0;\n        dispatch(selectAnnotation(sortedAnnotations[idx].id));\n        dispatch(softSetCurrentTime(sortedAnnotations[idx].time - 0.2));\n        break;\n\n      case 'ArrowUp':\n        idx =\n          sortedAnnotations.findIndex(\n            annotation => annotation.id === selected.id\n          ) - 1;\n        idx = idx >= 0 ? idx : sortedAnnotations.length - 1;\n        dispatch(selectAnnotation(sortedAnnotations[idx].id));\n        dispatch(softSetCurrentTime(sortedAnnotations[idx].time - 0.2));\n        break;\n\n      default:\n        break;\n    }\n  };\n\n  handleChange = annotationData => {\n    this.props.dispatch(\n      modifyAnnotation({\n        ...this.props.selected,\n        ...annotationData,\n      })\n    );\n  };\n\n  render() {\n    const { selected, secondWidth } = this.props;\n\n    if (!selected) {\n      return null;\n    }\n\n    // Single child is keyed to re-draw on annotation change.\n    return (\n      <SelectedAnnotation\n        key={selected.id}\n        time={selected.time}\n        duration={selected.duration}\n        name={selected.name}\n        secondWidth={secondWidth}\n        onKeyDown={this.handleKeyDown}\n        onChange={this.handleChange}\n      />\n    );\n  }\n}\n\nconst mapStateToProps = state => ({\n  sortedAnnotations: getSortedAnnotations(state),\n  selected: getSelectedAnnotation(state),\n  secondWidth: getSecondWidth(state),\n});\n\nexport default connect(mapStateToProps, undefined, undefined, {\n  storeKey: STORE_KEY,\n})(SelectedAnnotationWrapper);\n"],"names":["roundSec","duration","Math","round","roundMs","SelectedAnnotation","props","selectedRef","React","createRef","time","name","secondWidth","state","prevProps","setState","e","direction","pageX","startX","width","documentElement","classList","add","toUpperCase","addEventListener","drag","stopDragging","current","focus","remove","removeEventListener","onKeyDown","onBlur","containerWidth","max","durationLabel","startDraggingWest","startDraggingEast","PureComponent","startDragging","dragging","savedPageX","savedStartX","savedWidth","delta","deltaRestricted","min","onChange","SelectedAnnotationWrapper","handleKeyDown","sortedAnnotations","selected","dispatch","key","idx","deleteAnnotation","id","findIndex","annotation","length","selectAnnotation","softSetCurrentTime","handleChange","modifyAnnotation","annotationData","Component","mapStateToProps","getSortedAnnotations","getSelectedAnnotation","getSecondWidth","connect","undefined","STORE_KEY"],"mappings":"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"}