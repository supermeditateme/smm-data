{"version":3,"file":"index.js","sources":["../../../../../js/lib/components/CtrlClickCatcher/index.js"],"sourcesContent":["// This component is perhaps only temporary solution to 'create new annotation'\n// proplem. Capturing mouse events in scroller viewport should be redesigned.\n//\n// Not lifting state yet - component not mature enough.\n\nimport React, { PureComponent } from 'react';\nimport { connect } from 'react-redux';\n\nimport { STORE_KEY } from '../../constants';\nimport { createAnnotation, selectAnnotation } from '../../actions';\nimport {\n  getSelectedAnnotation,\n  getSecondWidth,\n  getCurrentPosition,\n} from '../../selectors';\n\nclass NewSelection extends PureComponent {\n  render() {\n    const { savedX, delta } = this.props;\n\n    if (savedX === null) {\n      return null;\n    }\n\n    const startX = delta >= 0 ? savedX : savedX + delta;\n    const width = Math.abs(delta);\n\n    return (\n      <div\n        className=\"newSelection\"\n        style={{ transform: `translateX(${startX}px)`, width }}\n      />\n    );\n  }\n}\nclass CtrlClickCatcher extends PureComponent {\n  constructor(props) {\n    super(props);\n\n    this.catcherRef = React.createRef();\n    this.state = { ctrlPressed: false, savedX: null, delta: null };\n  }\n\n  componentDidMount() {\n    document.documentElement.addEventListener(\n      'contextmenu',\n      this.preventContextMenu,\n      false\n    );\n    document.documentElement.addEventListener('keydown', this.onKeyDown, false);\n    document.documentElement.addEventListener('keyup', this.onKeyUp, false);\n  }\n\n  componentWillUnmount() {\n    document.documentElement.removeEventListener(\n      'contextmenu',\n      this.preventContextMenu,\n      false\n    );\n    document.documentElement.removeEventListener(\n      'keydown',\n      this.onKeyDown,\n      false\n    );\n    document.documentElement.removeEventListener('keyup', this.onKeyUp, false);\n    document.documentElement.removeEventListener(\n      'mousemove',\n      this.onMouseMove,\n      false\n    );\n  }\n\n  // Mac ctrl-click by default opens context menu. Prevent that.\n  preventContextMenu = e => {\n    if (process.env.NODE_ENV !== 'development') {\n      if (e.target === this.catcherRef.current) {\n        e.preventDefault();\n      }\n    }\n  };\n\n  onKeyDown = e => {\n    if (e.key === 'Control') {\n      this.setState({ ctrlPressed: true });\n    }\n  };\n\n  onKeyUp = e => {\n    if (e.key === 'Control') {\n      this.setState({ ctrlPressed: false });\n    }\n  };\n\n  onMouseDown = e => {\n    if (!e.ctrlKey) {\n      if (process.env.NODE_ENV === 'development') {\n        console.warn(\n          \"Clicked CtrlClickCatcher without ctrl key! Shouldn't happen.\"\n        );\n      }\n      this.setState({ ctrlPressed: false, savedX: null, delta: null });\n      return;\n    }\n\n    this.setState({ savedX: e.nativeEvent.offsetX, delta: 0 }, () => {\n      document.documentElement.addEventListener(\n        'mousemove',\n        this.onMouseMove,\n        false\n      );\n    });\n  };\n\n  onMouseMove = e => {\n    this.setState({\n      ctrlPressed: e.ctrlKey,\n      delta: e.offsetX - this.state.savedX,\n    });\n  };\n\n  onMouseUp = e => {\n    const { nameForAnnotation, secondWidth, currentPosition } = this.props;\n    const { savedX, delta } = this.state;\n    const startX = delta >= 0 ? savedX : savedX + delta;\n    const width = Math.abs(delta);\n\n    this.setState({ ctrlPressed: e.ctrlKey, savedX: null, delta: null }, () => {\n      const id = new Date().getTime(); // TODO come up with ID reconciliation between external app and this library\n      this.props.dispatch(\n        createAnnotation({\n          id,\n          name: nameForAnnotation,\n          time: (currentPosition + startX) / secondWidth,\n          duration: width / secondWidth,\n        })\n      );\n      this.props.dispatch(selectAnnotation(id));\n    });\n  };\n\n  render() {\n    const { viewportHeight } = this.props;\n    const { ctrlPressed, savedX, delta } = this.state;\n    return (\n      <div\n        className=\"ctrlClickCatcher\"\n        ref={this.catcherRef}\n        style={{\n          height: viewportHeight,\n          pointerEvents: ctrlPressed || savedX !== null ? 'unset' : 'none',\n        }}\n        onMouseDown={this.onMouseDown}\n        onMouseUp={this.onMouseUp}\n      >\n        <NewSelection savedX={savedX} delta={delta} />\n      </div>\n    );\n  }\n}\n\nconst mapStateToProps = state => ({\n  viewportHeight: state.presentation.viewportHeight,\n  nameForAnnotation: (\n    getSelectedAnnotation(state) ||\n    state.annotations.list[0] || { name: 'New annotation' }\n  ).name,\n  secondWidth: getSecondWidth(state),\n  currentPosition: getCurrentPosition(state),\n});\n\nexport default connect(mapStateToProps, undefined, undefined, {\n  storeKey: STORE_KEY,\n})(CtrlClickCatcher);\n"],"names":["NewSelection","props","savedX","delta","startX","width","Math","abs","React","transform","PureComponent","CtrlClickCatcher","preventContextMenu","process","env","NODE_ENV","e","target","catcherRef","current","preventDefault","onKeyDown","key","setState","ctrlPressed","onKeyUp","onMouseDown","ctrlKey","warn","nativeEvent","offsetX","documentElement","addEventListener","onMouseMove","state","onMouseUp","nameForAnnotation","secondWidth","currentPosition","id","Date","getTime","dispatch","createAnnotation","selectAnnotation","createRef","removeEventListener","viewportHeight","mapStateToProps","presentation","getSelectedAnnotation","annotations","list","name","getSecondWidth","getCurrentPosition","connect","undefined","STORE_KEY"],"mappings":"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"}