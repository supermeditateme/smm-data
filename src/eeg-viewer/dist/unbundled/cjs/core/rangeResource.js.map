{"version":3,"file":"rangeResource.js","sources":["../../../../js/lib/core/rangeResource.js"],"sourcesContent":["// Example resource for both streaming clients (e.g. Chrome) and non-streaming\n// clients (e.g. Firefox) with server that supports HTTP Range.\n\n/*\n  async API (returns abortable promises):\n    fetchHeader\n    loadChunks\n    loadAll (maybe?)\n    getRequestCount\n\n  events API: header, chunk, start, finish, error, destroy\n*/\n\nimport FunnelBuffer from './edf/funnelBuffer';\nimport ArrBuffer from './edf/arrBuffer';\nimport EdfHeader from './edf/edfHeader';\nimport streamReader from './edf/edfStreamReader';\nimport deferred from './deferred';\n\nfunction _defaultFetch(resource, options) {\n  return window.fetch(resource, { ...options, credentials: 'same-origin' });\n}\n\nclass ExampleRangeResource {\n  constructor(source, options = {}) {\n    this.url = source.url;\n    this._fetch =\n      typeof options.fetch === 'function' ? options.fetch : _defaultFetch;\n\n    this.header = null;\n    this.headerPromise = null;\n\n    this._subscribers = {\n      header: [],\n      chunk: [],\n      start: [],\n      finish: [],\n      error: [],\n      destroy: [],\n    };\n\n    this._requestCount = 0;\n    this.on('start', () => this._requestCount++);\n    this.on('finish', () => this._requestCount--);\n  }\n\n  getRequestCount() {\n    return this._requestCount;\n  }\n\n  fetchHeader() {\n    if (!this.headerPromise) {\n      this.headerPromise = this._fetchHeader().then(header => {\n        this._emit('header', header);\n        this.header = header;\n        return header;\n      });\n    }\n\n    return this.headerPromise;\n  }\n\n  _fetchHeader() {\n    this._emit('start');\n    const headerPromise = this._fetch(this.url, {\n      headers: new Headers({\n        Range: 'bytes=0-16384',\n      }),\n    })\n      .then(response => {\n        if (response.status !== 206)\n          throw new Error('EEG file range unavailable');\n\n        if (\n          'ReadableStream' in window &&\n          response.body instanceof ReadableStream\n        ) {\n          return response.body;\n        } else if (response.arrayBuffer) {\n          return response.arrayBuffer();\n        } else {\n          throw new Error('Unexpected response!');\n        }\n      })\n      .then(source => {\n        let stream;\n        switch (true) {\n          case 'ReadableStream' in window && source instanceof ReadableStream:\n            stream = new FunnelBuffer(source.getReader());\n            break;\n          case source instanceof ArrayBuffer:\n            stream = new ArrBuffer(new Uint8Array(source));\n            break;\n          default:\n            throw new Error('Unsupported source for edfStreamReader');\n            break;\n        }\n\n        return new EdfHeader(stream).then(header => {\n          this._emit('finish');\n          stream.stream && stream.stream.cancel();\n          return header;\n        });\n      });\n\n    return headerPromise;\n  }\n\n  loadChunks(start, size) {\n    if (!this.header) {\n      throw new Error(\n        'Header not fetched yet. Use promise-returning method fetchHeader().'\n      );\n    }\n\n    const totalSize = this.header.dataRecordsNumber;\n    if (start < 0 || start + size - 1 > totalSize) {\n      // prettier-ignore\n      throw new Error(\n        `Incorrect start/size supplied to loadChunks(): ${start}, ${size} (total edf size is ${totalSize})`\n      );\n    }\n\n    // Start fetching data range.\n    const requestId = new Date().getTime();\n    this._fetchChunks(requestId, start, size);\n\n    return [requestId, start, size];\n  }\n\n  _fetchChunks(requestId, start, size) {\n    return new Promise((resolve, reject) => {\n      this._emit('start', requestId);\n      // TODO cancel stream on destroy somehow.\n\n      const { headerSize, signals } = this.header;\n\n      const dataRecordSize =\n        signals.reduce((acc, v) => acc + v.sampleRate, 0) * 2;\n\n      const bytesStart = headerSize + start * dataRecordSize;\n      const bytesEnd = headerSize + (start + size) * dataRecordSize - 1; // HTTP Range is inclusive; https://tools.ietf.org/html/rfc7233\n\n      this._fetch(this.url, {\n        headers: new Headers({\n          Range: `bytes=${bytesStart}-${bytesEnd}`,\n        }),\n      })\n        .then(response => {\n          if (response.status !== 206)\n            throw new Error('EEG file range unavailable');\n\n          if (\n            'ReadableStream' in window &&\n            response.body instanceof ReadableStream\n          ) {\n            return response.body;\n          } else if (response.arrayBuffer) {\n            return response.arrayBuffer();\n          } else {\n            throw new Error('Unexpected response!');\n          }\n        })\n        .then(source => {\n          return streamReader(\n            source,\n            (dataRecord, index, total, edfHeader) => {\n              // edf's readDataRecords() method does one extra callback with null\n              // after finish. We check for index being not greater than requested,\n              // to emit 'chunk' events correctly.\n              if (index < size) {\n                this._emit('chunk', start + index, dataRecord, requestId);\n              }\n\n              if (process.env.NODE_ENV === 'development') {\n                if (index >= size) {\n                  console.info(\n                    'ignored: index, start, size',\n                    index,\n                    start,\n                    size\n                  );\n                }\n              }\n\n              if (index === size - 1) {\n                this._emit('finish', requestId);\n                resolve(index, total);\n              }\n            },\n            this.header\n          );\n        });\n    });\n  }\n\n  // Pubsub implementation\n  _emit(event, ...data) {\n    for (let callback of this._subscribers[event]) {\n      callback(...data);\n    }\n  }\n\n  on(event, callback) {\n    if (!this._subscribers[event]) {\n      console.warn(`Event ${event} not supported; ignoring.`);\n      return false;\n    }\n\n    this._subscribers[event].push(callback);\n    return () => this.off(event, callback);\n  }\n\n  off(event, callback) {\n    if (!this._subscribers[event]) {\n      console.warn(`Event ${event} not supported; ignoring.`);\n      return false;\n    }\n\n    const prevLength = this._subscribers[event].length;\n    this._subscribers[event] = this._subscribers[event].filter(function(cb) {\n      return cb !== callback;\n    });\n\n    return prevLength > this._subscribers[event].length;\n  }\n\n  // TODO destroy method; more.\n  destroy() {\n    this._emit('destroy');\n  }\n}\n\nexport default ExampleRangeResource;\n"],"names":["_defaultFetch","resource","options","window","fetch","credentials","ExampleRangeResource","source","url","_fetch","header","headerPromise","_subscribers","_requestCount","on","_fetchHeader","then","_emit","Headers","response","status","Error","body","ReadableStream","arrayBuffer","stream","FunnelBuffer","getReader","ArrayBuffer","ArrBuffer","Uint8Array","EdfHeader","cancel","start","size","totalSize","dataRecordsNumber","requestId","Date","getTime","_fetchChunks","Promise","resolve","reject","headerSize","signals","dataRecordSize","reduce","acc","v","sampleRate","bytesStart","bytesEnd","streamReader","dataRecord","index","total","edfHeader","process","env","NODE_ENV","info","event","data","callback","warn","push","off","prevLength","length","filter","cb"],"mappings":";;;;;;;;;;;;;;AAmBA,SAASA,aAAT,CAAuBC,QAAvB,EAAiCC,OAAjC,EAA0C;SACjCC,OAAOC,KAAP,CAAaH,QAAb,eAA4BC,OAA5B,IAAqCG,aAAa,aAAlD,IAAP;;;IAGIC;gCACQC,MAAZ,EAAkC;;;QAAdL,OAAc,uEAAJ,EAAI;;;;SAC3BM,GAAL,GAAWD,OAAOC,GAAlB;SACKC,MAAL,GACE,OAAOP,QAAQE,KAAf,KAAyB,UAAzB,GAAsCF,QAAQE,KAA9C,GAAsDJ,aADxD;;SAGKU,MAAL,GAAc,IAAd;SACKC,aAAL,GAAqB,IAArB;;SAEKC,YAAL,GAAoB;cACV,EADU;aAEX,EAFW;aAGX,EAHW;cAIV,EAJU;aAKX,EALW;eAMT;KANX;;SASKC,aAAL,GAAqB,CAArB;SACKC,EAAL,CAAQ,OAAR,EAAiB;aAAM,MAAKD,aAAL,EAAN;KAAjB;SACKC,EAAL,CAAQ,QAAR,EAAkB;aAAM,MAAKD,aAAL,EAAN;KAAlB;;;;;sCAGgB;aACT,KAAKA,aAAZ;;;;kCAGY;;;UACR,CAAC,KAAKF,aAAV,EAAyB;aAClBA,aAAL,GAAqB,KAAKI,YAAL,GAAoBC,IAApB,CAAyB,kBAAU;iBACjDC,KAAL,CAAW,QAAX,EAAqBP,MAArB;iBACKA,MAAL,GAAcA,MAAd;iBACOA,MAAP;SAHmB,CAArB;;;aAOK,KAAKC,aAAZ;;;;mCAGa;;;WACRM,KAAL,CAAW,OAAX;UACMN,gBAAgB,KAAKF,MAAL,CAAY,KAAKD,GAAjB,EAAsB;iBACjC,IAAIU,OAAJ,CAAY;iBACZ;SADA;OADW,EAKnBF,IALmB,CAKd,oBAAY;YACZG,SAASC,MAAT,KAAoB,GAAxB,EACE,MAAM,IAAIC,KAAJ,CAAU,4BAAV,CAAN;;YAGA,oBAAoBlB,MAApB,IACAgB,SAASG,IAAT,YAAyBC,cAF3B,EAGE;iBACOJ,SAASG,IAAhB;SAJF,MAKO,IAAIH,SAASK,WAAb,EAA0B;iBACxBL,SAASK,WAAT,EAAP;SADK,MAEA;gBACC,IAAIH,KAAJ,CAAU,sBAAV,CAAN;;OAjBgB,EAoBnBL,IApBmB,CAoBd,kBAAU;YACVS,eAAJ;gBACQ,IAAR;eACO,oBAAoBtB,MAApB,IAA8BI,kBAAkBgB,cAArD;qBACW,IAAIG,kBAAJ,CAAiBnB,OAAOoB,SAAP,EAAjB,CAAT;;eAEGpB,kBAAkBqB,WAAvB;qBACW,IAAIC,kBAAJ,CAAc,IAAIC,UAAJ,CAAevB,MAAf,CAAd,CAAT;;;kBAGM,IAAIc,KAAJ,CAAU,wCAAV,CAAN;;;;eAIG,IAAIU,kBAAJ,CAAcN,MAAd,EAAsBT,IAAtB,CAA2B,kBAAU;iBACrCC,KAAL,CAAW,QAAX;iBACOQ,MAAP,IAAiBA,OAAOA,MAAP,CAAcO,MAAd,EAAjB;iBACOtB,MAAP;SAHK,CAAP;OAlCkB,CAAtB;;aAyCOC,aAAP;;;;+BAGSsB,OAAOC,MAAM;UAClB,CAAC,KAAKxB,MAAV,EAAkB;cACV,IAAIW,KAAJ,CACJ,qEADI,CAAN;;;UAKIc,YAAY,KAAKzB,MAAL,CAAY0B,iBAA9B;UACIH,QAAQ,CAAR,IAAaA,QAAQC,IAAR,GAAe,CAAf,GAAmBC,SAApC,EAA+C;;cAEvC,IAAId,KAAJ,qDAC8CY,KAD9C,UACwDC,IADxD,4BACmFC,SADnF,OAAN;;;;UAMIE,YAAY,IAAIC,IAAJ,GAAWC,OAAX,EAAlB;WACKC,YAAL,CAAkBH,SAAlB,EAA6BJ,KAA7B,EAAoCC,IAApC;;aAEO,CAACG,SAAD,EAAYJ,KAAZ,EAAmBC,IAAnB,CAAP;;;;iCAGWG,WAAWJ,OAAOC,MAAM;;;aAC5B,IAAIO,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;eACjC1B,KAAL,CAAW,OAAX,EAAoBoB,SAApB;;;sBAGgC,OAAK3B,MAJC;YAI9BkC,UAJ8B,WAI9BA,UAJ8B;YAIlBC,OAJkB,WAIlBA,OAJkB;;;YAMhCC,iBACJD,QAAQE,MAAR,CAAe,UAACC,GAAD,EAAMC,CAAN;iBAAYD,MAAMC,EAAEC,UAApB;SAAf,EAA+C,CAA/C,IAAoD,CADtD;;YAGMC,aAAaP,aAAaX,QAAQa,cAAxC;YACMM,WAAWR,aAAa,CAACX,QAAQC,IAAT,IAAiBY,cAA9B,GAA+C,CAAhE,CAVsC;;eAYjCrC,MAAL,CAAY,OAAKD,GAAjB,EAAsB;mBACX,IAAIU,OAAJ,CAAY;8BACHiC,UAAhB,SAA8BC;WADvB;SADX,EAKGpC,IALH,CAKQ,oBAAY;cACZG,SAASC,MAAT,KAAoB,GAAxB,EACE,MAAM,IAAIC,KAAJ,CAAU,4BAAV,CAAN;;cAGA,oBAAoBlB,MAApB,IACAgB,SAASG,IAAT,YAAyBC,cAF3B,EAGE;mBACOJ,SAASG,IAAhB;WAJF,MAKO,IAAIH,SAASK,WAAb,EAA0B;mBACxBL,SAASK,WAAT,EAAP;WADK,MAEA;kBACC,IAAIH,KAAJ,CAAU,sBAAV,CAAN;;SAjBN,EAoBGL,IApBH,CAoBQ,kBAAU;iBACPqC,mBACL9C,MADK,EAEL,UAAC+C,UAAD,EAAaC,KAAb,EAAoBC,KAApB,EAA2BC,SAA3B,EAAyC;;;;gBAInCF,QAAQrB,IAAZ,EAAkB;qBACXjB,KAAL,CAAW,OAAX,EAAoBgB,QAAQsB,KAA5B,EAAmCD,UAAnC,EAA+CjB,SAA/C;;;gBAGEqB,QAAQC,GAAR,CAAYC,QAAZ,KAAyB,aAA7B,EAA4C;kBACtCL,SAASrB,IAAb,EAAmB;wBACT2B,IAAR,CACE,6BADF,EAEEN,KAFF,EAGEtB,KAHF,EAIEC,IAJF;;;;gBASAqB,UAAUrB,OAAO,CAArB,EAAwB;qBACjBjB,KAAL,CAAW,QAAX,EAAqBoB,SAArB;sBACQkB,KAAR,EAAeC,KAAf;;WAvBC,EA0BL,OAAK9C,MA1BA,CAAP;SArBJ;OAZK,CAAP;;;;;;;0BAkEIoD,OAAgB;wCAANC,IAAM;YAAA;;;;;;;;6BACC,KAAKnD,YAAL,CAAkBkD,KAAlB,CAArB,8HAA+C;cAAtCE,QAAsC;;oCACjCD,IAAZ;;;;;;;;;;;;;;;;;;;uBAIDD,OAAOE,UAAU;;;UACd,CAAC,KAAKpD,YAAL,CAAkBkD,KAAlB,CAAL,EAA+B;gBACrBG,IAAR,YAAsBH,KAAtB;eACO,KAAP;;;WAGGlD,YAAL,CAAkBkD,KAAlB,EAAyBI,IAAzB,CAA8BF,QAA9B;aACO;eAAM,OAAKG,GAAL,CAASL,KAAT,EAAgBE,QAAhB,CAAN;OAAP;;;;wBAGEF,OAAOE,UAAU;UACf,CAAC,KAAKpD,YAAL,CAAkBkD,KAAlB,CAAL,EAA+B;gBACrBG,IAAR,YAAsBH,KAAtB;eACO,KAAP;;;UAGIM,aAAa,KAAKxD,YAAL,CAAkBkD,KAAlB,EAAyBO,MAA5C;WACKzD,YAAL,CAAkBkD,KAAlB,IAA2B,KAAKlD,YAAL,CAAkBkD,KAAlB,EAAyBQ,MAAzB,CAAgC,UAASC,EAAT,EAAa;eAC/DA,OAAOP,QAAd;OADyB,CAA3B;;aAIOI,aAAa,KAAKxD,YAAL,CAAkBkD,KAAlB,EAAyBO,MAA7C;;;;;;;8BAIQ;WACHpD,KAAL,CAAW,SAAX;;;;;;;;;"}