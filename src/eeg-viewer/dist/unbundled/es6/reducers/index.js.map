{"version":3,"file":"index.js","sources":["../../../../js/lib/reducers/index.js"],"sourcesContent":["import { combineReducers } from 'redux';\nimport navigationReducer from './navigation';\nimport presentationReducer from './presentation';\nimport headerReducer from './header';\nimport dataReducer from './data';\nimport viewModeReducer from './viewMode';\nimport annotationsReducer from './annotations';\nimport annotationHistoryReducer, {\n  annotationHistoryNoopReducer,\n} from './annotationHistory';\n\nimport {\n  ADD_DATA_SEGMENT_30S,\n  ADD_DERIVED_SEGMENT_30S,\n  ADD_COORDINATES_SEGMENT_30S,\n  SET_SCROLLER_PARAMS,\n  SET_VIEWPORT_PARAMS,\n  SET_VISIBLE_CHANNELS,\n  SET_INPUT_MONTAGE,\n  SET_BIPOLAR_MONTAGE,\n  SET_DEFAULT_AMPLITUDE,\n} from '../actions';\n\nimport { getDerivedChannels, getFileDuration } from '../selectors';\n\nimport calculateCoordinates from '../workers/calculateCoordinates';\nimport calculateDerived from '../workers/calculateDerived';\n\nconst regularReducer = combineReducers({\n  navigation: navigationReducer,\n  presentation: presentationReducer,\n  header: headerReducer,\n  data: dataReducer,\n  viewMode: viewModeReducer,\n  annotations: annotationsReducer,\n  annotationHistory: annotationHistoryNoopReducer,\n});\n\n// TODO develop selectors to determine if recalc is needed.\n\n// This full-state reducer manages dependencies for `data` slice of store. It\n// does so in a synchronous manner.\nfunction dataDependencyReducer(state, action) {\n  const { type, payload } = action;\n\n  switch (type) {\n    case ADD_DATA_SEGMENT_30S:\n      const newState = { ...state };\n      newState.data = { ...newState.data };\n\n      const rawSegment = payload.data;\n      const derivedSegment = calculateDerived(\n        rawSegment,\n        state.header.signals,\n        getDerivedChannels(state)\n      );\n      const coordinatesSegment = calculateCoordinates(\n        derivedSegment,\n        state.header.signals,\n        state.presentation.viewportHeight /\n          state.viewMode.visibleChannels.length,\n        state.viewMode.channelDefaults.amplitude //TODO TODO\n      );\n\n      newState.data.derivedValues[payload.index] = derivedSegment;\n      newState.data.onScreenCoordinates[payload.index] = coordinatesSegment;\n\n      return newState;\n\n    case ADD_DERIVED_SEGMENT_30S: {\n      const newState = { ...state };\n      newState.data = { ...newState.data };\n\n      const derivedSegment = payload.data;\n      const coordinatesSegment = calculateCoordinates(\n        derivedSegment,\n        state.header.signals,\n        state.presentation.viewportHeight /\n          state.viewMode.visibleChannels.length,\n        state.viewMode.channelDefaults.amplitude //TODO TODO\n      );\n\n      newState.data.onScreenCoordinates[payload.index] = coordinatesSegment;\n\n      return newState;\n    }\n\n    case SET_VISIBLE_CHANNELS:\n    case SET_INPUT_MONTAGE:\n    case SET_BIPOLAR_MONTAGE:\n    case SET_DEFAULT_AMPLITUDE:\n    case SET_SCROLLER_PARAMS:\n    case SET_VIEWPORT_PARAMS: {\n      // TODO Also - signals, viewportHeight, amplitude...\n      const newState = { ...state };\n      newState.data = { ...newState.data };\n\n      for (let i = 0; i < newState.data.onScreenCoordinates.length; i++) {\n        if (!newState.data.onScreenCoordinates[i]) {\n          continue;\n        }\n\n        const derivedSegment = newState.data.derivedValues[i];\n        const coordinatesSegment = calculateCoordinates(\n          derivedSegment,\n          state.header.signals,\n          state.presentation.viewportHeight /\n            state.viewMode.visibleChannels.length,\n          state.viewMode.channelDefaults.amplitude //TODO TODO\n        );\n\n        newState.data.onScreenCoordinates[i] = coordinatesSegment;\n      }\n\n      return newState;\n    }\n\n    case ADD_COORDINATES_SEGMENT_30S:\n      // Do nothing; coordinates data added in regularReducer, and no other data\n      // depends on it.\n      return state;\n\n    default:\n      return state;\n  }\n}\n\n// This default reducer combines data deps calculation and other, non-related\n// complex actions like guarding against out-of-bounds navigation.\nfunction rootReducer(state, action) {\n  const regularState = regularReducer(state, action);\n  const annotationHistoryState = annotationHistoryReducer(regularState, action);\n  const dataDependenciesState = dataDependencyReducer(\n    annotationHistoryState,\n    action\n  );\n\n  const { navigation } = dataDependenciesState;\n  const maxTime = getFileDuration(dataDependenciesState) - navigation.epochSize;\n  navigation.currentTime = Math.max(\n    0,\n    Math.min(navigation.currentTime, maxTime)\n  );\n\n  return dataDependenciesState;\n}\n\nexport { rootReducer, regularReducer };\nexport default rootReducer;\n"],"names":["regularReducer","combineReducers","navigationReducer","presentationReducer","headerReducer","dataReducer","viewModeReducer","annotationsReducer","annotationHistoryNoopReducer","dataDependencyReducer","state","action","type","payload","ADD_DATA_SEGMENT_30S","newState","data","rawSegment","derivedSegment","calculateDerived","header","signals","getDerivedChannels","coordinatesSegment","calculateCoordinates","presentation","viewportHeight","viewMode","visibleChannels","length","channelDefaults","amplitude","derivedValues","index","onScreenCoordinates","ADD_DERIVED_SEGMENT_30S","SET_VISIBLE_CHANNELS","SET_INPUT_MONTAGE","SET_BIPOLAR_MONTAGE","SET_DEFAULT_AMPLITUDE","SET_SCROLLER_PARAMS","SET_VIEWPORT_PARAMS","i","ADD_COORDINATES_SEGMENT_30S","rootReducer","regularState","annotationHistoryState","annotationHistoryReducer","dataDependenciesState","navigation","maxTime","getFileDuration","epochSize","currentTime","Math","max","min"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;AA4BA,IAAMA,iBAAiBC,gBAAgB;cACzBC,iBADyB;gBAEvBC,mBAFuB;UAG7BC,aAH6B;QAI/BC,WAJ+B;YAK3BC,eAL2B;eAMxBC,kBANwB;qBAOlBC;CAPE,CAAvB;;;;;;AAcA,SAASC,qBAAT,CAA+BC,KAA/B,EAAsCC,MAAtC,EAA8C;MACpCC,IADoC,GAClBD,MADkB,CACpCC,IADoC;MAC9BC,OAD8B,GAClBF,MADkB,CAC9BE,OAD8B;;;UAGpCD,IAAR;SACOE,oBAAL;UACQC,wBAAgBL,KAAhB,CAAN;eACSM,IAAT,gBAAqBD,SAASC,IAA9B;;UAEMC,aAAaJ,QAAQG,IAA3B;UACME,iBAAiBC,iBACrBF,UADqB,EAErBP,MAAMU,MAAN,CAAaC,OAFQ,EAGrBC,mBAAmBZ,KAAnB,CAHqB,CAAvB;UAKMa,qBAAqBC,qBACzBN,cADyB,EAEzBR,MAAMU,MAAN,CAAaC,OAFY,EAGzBX,MAAMe,YAAN,CAAmBC,cAAnB,GACEhB,MAAMiB,QAAN,CAAeC,eAAf,CAA+BC,MAJR,EAKzBnB,MAAMiB,QAAN,CAAeG,eAAf,CAA+BC,SALN;OAA3B;;eAQSf,IAAT,CAAcgB,aAAd,CAA4BnB,QAAQoB,KAApC,IAA6Cf,cAA7C;eACSF,IAAT,CAAckB,mBAAd,CAAkCrB,QAAQoB,KAA1C,IAAmDV,kBAAnD;;aAEOR,QAAP;;SAEGoB,uBAAL;;YACQpB,yBAAgBL,KAAhB,CAAN;kBACSM,IAAT,gBAAqBD,UAASC,IAA9B;;YAEME,kBAAiBL,QAAQG,IAA/B;YACMO,sBAAqBC,qBACzBN,eADyB,EAEzBR,MAAMU,MAAN,CAAaC,OAFY,EAGzBX,MAAMe,YAAN,CAAmBC,cAAnB,GACEhB,MAAMiB,QAAN,CAAeC,eAAf,CAA+BC,MAJR,EAKzBnB,MAAMiB,QAAN,CAAeG,eAAf,CAA+BC,SALN;SAA3B;;kBAQSf,IAAT,CAAckB,mBAAd,CAAkCrB,QAAQoB,KAA1C,IAAmDV,mBAAnD;;eAEOR,SAAP;;;SAGGqB,oBAAL;SACKC,iBAAL;SACKC,mBAAL;SACKC,qBAAL;SACKC,mBAAL;SACKC,mBAAL;;;YAEQ1B,0BAAgBL,KAAhB,CAAN;mBACSM,IAAT,gBAAqBD,WAASC,IAA9B;;aAEK,IAAI0B,IAAI,CAAb,EAAgBA,IAAI3B,WAASC,IAAT,CAAckB,mBAAd,CAAkCL,MAAtD,EAA8Da,GAA9D,EAAmE;cAC7D,CAAC3B,WAASC,IAAT,CAAckB,mBAAd,CAAkCQ,CAAlC,CAAL,EAA2C;;;;cAIrCxB,mBAAiBH,WAASC,IAAT,CAAcgB,aAAd,CAA4BU,CAA5B,CAAvB;cACMnB,uBAAqBC,qBACzBN,gBADyB,EAEzBR,MAAMU,MAAN,CAAaC,OAFY,EAGzBX,MAAMe,YAAN,CAAmBC,cAAnB,GACEhB,MAAMiB,QAAN,CAAeC,eAAf,CAA+BC,MAJR,EAKzBnB,MAAMiB,QAAN,CAAeG,eAAf,CAA+BC,SALN;WAA3B;;qBAQSf,IAAT,CAAckB,mBAAd,CAAkCQ,CAAlC,IAAuCnB,oBAAvC;;;eAGKR,UAAP;;;SAGG4B,2BAAL;;;aAGSjC,KAAP;;;aAGOA,KAAP;;;;;;AAMN,SAASkC,WAAT,CAAqBlC,KAArB,EAA4BC,MAA5B,EAAoC;MAC5BkC,eAAe7C,eAAeU,KAAf,EAAsBC,MAAtB,CAArB;MACMmC,yBAAyBC,yBAAyBF,YAAzB,EAAuClC,MAAvC,CAA/B;MACMqC,wBAAwBvC,sBAC5BqC,sBAD4B,EAE5BnC,MAF4B,CAA9B;;MAKQsC,UAR0B,GAQXD,qBARW,CAQ1BC,UAR0B;;MAS5BC,UAAUC,gBAAgBH,qBAAhB,IAAyCC,WAAWG,SAApE;aACWC,WAAX,GAAyBC,KAAKC,GAAL,CACvB,CADuB,EAEvBD,KAAKE,GAAL,CAASP,WAAWI,WAApB,EAAiCH,OAAjC,CAFuB,CAAzB;;SAKOF,qBAAP;;;;;;"}